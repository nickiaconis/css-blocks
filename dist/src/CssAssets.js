"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const async = require("async");
const convertSourceMap = require("convert-source-map");
const debugGenerator = require("debug");
const fs = require("fs");
const opticss_1 = require("opticss");
const path = require("path");
const webpack_sources_1 = require("webpack-sources");
const debug = debugGenerator("css-blocks:webpack:assets");
function isPostcssProcessor(processor) {
    return !!processor.postcss;
}
function isGenericProcessor(processor) {
    return !!processor.processor;
}
class CssAssets {
    constructor(options) {
        let defaultOpts = { cssFiles: {}, concat: {}, emitSourceMaps: true, inlineSourceMaps: false };
        this.options = Object.assign(defaultOpts, options);
    }
    apply(compiler) {
        // install assets
        // This puts assets into the compilation results but they won't be part of
        // any chunk. the cssFiles option is an object where the keys are
        // the asset to be added into the compilation results. The value
        // can be a path relative to the webpack project root or an absolute path.
        // TODO: get the watcher to watch these files on disk
        // TODO: Use loaders to get these files into the assets -- which may help with the watching.
        compiler.plugin("emit", (compilation, cb) => {
            debug("emitting assets");
            let assetPaths = Object.keys(this.options.cssFiles);
            async.forEach(assetPaths, (assetPath, outputCallback) => {
                let asset = this.options.cssFiles[assetPath];
                let sourcePath, chunkName = undefined;
                if (typeof asset === "string" || Array.isArray(asset)) {
                    sourcePath = asset;
                }
                else {
                    sourcePath = asset.source;
                    chunkName = asset.chunk;
                }
                let chunks = compilation.chunks;
                let chunk = chunkName && chunks.find(c => c.name === chunkName);
                if (chunkName && !chunk) {
                    throw new Error(`No chunk named ${chunkName} found.`);
                }
                const handleSource = (err, source) => {
                    if (err) {
                        outputCallback(err);
                    }
                    else {
                        compilation.assets[assetPath] = source;
                        if (chunk) {
                            chunk.files.push(assetPath);
                        }
                        outputCallback();
                    }
                };
                if (Array.isArray(sourcePath)) {
                    const sourcePaths = sourcePath.map(sourcePath => path.resolve(compiler.options.context, sourcePath));
                    assetFilesAsSource(sourcePaths, handleSource);
                }
                else {
                    assetFileAsSource(path.resolve(compiler.options.context, sourcePath), handleSource);
                }
            }, cb);
        });
        // Concatenation
        // The concat option is an object where the keys are the
        // concatenated asset path and the value is an array of
        // strings of assets that should be in the asset.
        // TODO: maybe some glob or regex support
        compiler.plugin("emit", (compilation, cb) => {
            debug("concatenating assets");
            if (!this.options.concat)
                return;
            let concatFiles = Object.keys(this.options.concat);
            let postProcessResults = new Array();
            for (let concatFile of concatFiles) {
                let concatSource = new webpack_sources_1.ConcatSource();
                let concatenation = this.options.concat[concatFile];
                let inputFiles = Array.isArray(concatenation) ? concatenation : concatenation.sources;
                let concatenationOptions = Array.isArray(concatenation) ? { sources: concatenation } : concatenation;
                let missingFiles = inputFiles.filter(f => (!compilation.assets[f]));
                let chunks = new Set();
                if (missingFiles.length === 0) {
                    for (let inputFile of inputFiles) {
                        let asset = compilation.assets[inputFile];
                        concatSource.add(asset);
                        let chunksWithInputAsset = compilation.chunks.filter((chunk) => chunk.files.indexOf(inputFile) >= 0);
                        chunksWithInputAsset.forEach((chunk) => {
                            chunks.add(chunk);
                            let files = chunk.files;
                            chunk.files = files.filter(file => file !== inputFile);
                        });
                        if (!concatenationOptions.preserveSourceFiles) {
                            delete compilation.assets[inputFile];
                        }
                    }
                    if (concatenationOptions.postProcess) {
                        postProcessResults.push(postProcess(concatenationOptions.postProcess, concatSource, concatFile).then(source => {
                            compilation.assets[concatFile] = source;
                        }));
                    }
                    else {
                        compilation.assets[concatFile] = concatSource;
                    }
                }
                for (let chunk of chunks) {
                    let files = chunk.files;
                    if (files.indexOf(concatFile) >= 0)
                        continue;
                    files.push(concatFile);
                }
            }
            if (postProcessResults.length > 0) {
                Promise.all(postProcessResults).then(() => {
                    cb();
                }, error => {
                    cb(error);
                });
            }
            else {
                cb();
            }
        });
        // sourcemap output for css files
        // Emit all css files with sourcemaps when the `emitSourceMaps` option
        // is set to true (default). By default source maps are generated as a
        // separate file but they can be inline by setting `inlineSourceMaps` to
        // true (false by default)
        compiler.plugin("emit", (compilation, cb) => {
            if (!this.options.emitSourceMaps) {
                debug("not adding sourcemaps");
                cb();
                return;
            }
            debug("adding sourcemaps");
            let assetPaths = Object.keys(compilation.assets).filter(p => /\.css$/.test(p));
            assetPaths.forEach(assetPath => {
                let asset = compilation.assets[assetPath];
                let { source, map } = sourceAndMap(asset);
                if (map) {
                    let comment;
                    if (this.options.inlineSourceMaps) {
                        comment = convertSourceMap.fromObject(map).toComment({ multiline: true });
                    }
                    else {
                        let mapPath = assetPath + ".map";
                        comment = `/*# sourceMappingURL=${path.basename(mapPath)} */`;
                        compilation.assets[mapPath] = new webpack_sources_1.RawSource(JSON.stringify(map));
                    }
                    compilation.assets[assetPath] = new webpack_sources_1.RawSource(source + "\n" + comment);
                }
            });
            cb();
        });
    }
}
exports.CssAssets = CssAssets;
function assetAsSource(contents, filename) {
    let sourcemap;
    if (/sourceMappingURL/.test(contents)) {
        sourcemap = convertSourceMap.fromSource(contents) ||
            convertSourceMap.fromMapFileComment(contents, path.dirname(filename));
    }
    if (sourcemap) {
        let sm = sourcemap.toObject();
        contents = convertSourceMap.removeComments(contents);
        contents = convertSourceMap.removeMapFileComments(contents);
        return new webpack_sources_1.SourceMapSource(contents, filename, sm);
    }
    else {
        return new webpack_sources_1.RawSource(contents);
    }
}
function assetFilesAsSource(filenames, callback) {
    let assetSource = new webpack_sources_1.ConcatSource();
    let assetFiles = filenames.slice();
    let eachAssetFile = (err) => {
        if (err) {
            callback(err);
        }
        else {
            const nextAssetFile = assetFiles.shift();
            if (nextAssetFile) {
                processAsset(nextAssetFile, eachAssetFile);
            }
            else {
                callback(undefined, assetSource);
            }
        }
    };
    const firstAssetFile = assetFiles.shift();
    if (firstAssetFile) {
        processAsset(firstAssetFile, eachAssetFile);
    }
    else {
        callback(new Error("No asset files provided."));
    }
    function processAsset(assetPath, assetCallback) {
        fs.readFile(assetPath, "utf-8", (err, data) => {
            if (err) {
                assetCallback(err);
            }
            else {
                assetSource.add(assetAsSource(data, assetPath));
                assetCallback();
            }
        });
    }
}
function assetFileAsSource(sourcePath, callback) {
    fs.readFile(sourcePath, "utf-8", (err, contents) => {
        if (err) {
            callback(err);
        }
        else {
            try {
                callback(undefined, assetAsSource(contents, sourcePath));
            }
            catch (e) {
                callback(e);
            }
        }
    });
}
function sourceAndMap(asset) {
    // sourceAndMap is supposedly more efficient when implemented.
    if (asset.sourceAndMap) {
        return asset.sourceAndMap();
    }
    else {
        let source = asset.source();
        let map = undefined;
        if (asset.map) {
            map = asset.map();
        }
        return { source, map };
    }
}
function makePostcssProcessor(plugins) {
    return (asset, assetPath) => {
        let { source, map } = sourceAndMap(asset);
        let pluginsPromise;
        if (typeof plugins === "function") {
            pluginsPromise = Promise.resolve(plugins(assetPath));
        }
        else {
            if (plugins.length > 0) {
                pluginsPromise = Promise.resolve(plugins);
            }
            else {
                return Promise.resolve(asset);
            }
        }
        return pluginsPromise.then(plugins => {
            let processor = opticss_1.postcss(plugins);
            let result = processor.process(source, {
                to: assetPath,
                map: { prev: map, inline: false, annotation: false },
            });
            return result.then((result) => {
                return new webpack_sources_1.SourceMapSource(result.css, assetPath, result.map.toJSON(), source, map);
            });
        });
    };
}
function process(processor, asset, assetPath) {
    return Promise.resolve(processor(asset, assetPath));
}
function postProcess(option, asset, assetPath) {
    let promise;
    if (isPostcssProcessor(option)) {
        promise = process(makePostcssProcessor(option.postcss), asset, assetPath);
    }
    else {
        promise = Promise.resolve(asset);
    }
    if (isGenericProcessor(option)) {
        promise = promise.then(asset => {
            return process(option.processor, asset, assetPath);
        });
    }
    return promise;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ3NzQXNzZXRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL0Nzc0Fzc2V0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLCtCQUFnQztBQUNoQyx1REFBdUQ7QUFDdkQsd0NBQXdDO0FBQ3hDLHlCQUF5QjtBQUN6QixxQ0FBa0M7QUFDbEMsNkJBQTZCO0FBRzdCLHFEQUFtRjtBQU9uRixNQUFNLEtBQUssR0FBRyxjQUFjLENBQUMsMkJBQTJCLENBQUMsQ0FBQztBQW9CMUQsU0FBUyxrQkFBa0IsQ0FBQyxTQUE4QjtJQUN0RCxPQUFPLENBQUMsQ0FBMEIsU0FBVSxDQUFDLE9BQU8sQ0FBQztBQUN6RCxDQUFDO0FBRUQsU0FBUyxrQkFBa0IsQ0FBQyxTQUE4QjtJQUN0RCxPQUFPLENBQUMsQ0FBMEIsU0FBVSxDQUFDLFNBQVMsQ0FBQztBQUMzRCxDQUFDO0FBb0VELE1BQWEsU0FBUztJQUVwQixZQUFZLE9BQWtDO1FBQ3hDLElBQUksV0FBVyxHQUFxQixFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLGdCQUFnQixFQUFFLEtBQUssRUFBRSxDQUFDO1FBQ2hILElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVILEtBQUssQ0FBQyxRQUF5QjtRQUN6QixpQkFBaUI7UUFDakIsMEVBQTBFO1FBQzFFLGlFQUFpRTtRQUNqRSxnRUFBZ0U7UUFDaEUsMEVBQTBFO1FBQzFFLHFEQUFxRDtRQUNyRCw0RkFBNEY7UUFDNUYsUUFBUSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxXQUFXLEVBQUUsRUFBRSxFQUFFLEVBQUU7WUFDeEMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUM7WUFDekIsSUFBSSxVQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJ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LE9BQU8sR0FBRyxPQUFPLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFLEtBQUssRUFBRSxTQUFTLENBQUMsQ0FBQztLQUM3RTtTQUFNO1FBQ0gsT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7S0FDcEM7SUFDRCxJQUFJLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxFQUFFO1FBQzVCLE9BQU8sR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQzNCLE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZELENBQUMsQ0FBQyxDQUFDO0tBQ047SUFDRCxPQUFPLE9BQU8sQ0FBQztBQUNuQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JqZWN0RGljdGlvbmFyeSB9IGZyb20gXCJAb3B0aWNzcy91dGlsXCI7XG5pbXBvcnQgKiBhcyAgYXN5bmMgZnJvbSBcImFzeW5jXCI7XG5pbXBvcnQgKiBhcyBjb252ZXJ0U291cmNlTWFwIGZyb20gXCJjb252ZXJ0LXNvdXJjZS1tYXBcIjtcbmltcG9ydCAqIGFzIGRlYnVnR2VuZXJhdG9yIGZyb20gXCJkZWJ1Z1wiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgeyBwb3N0Y3NzIH0gZnJvbSBcIm9wdGljc3NcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCB7IFJhd1NvdXJjZU1hcCB9IGZyb20gXCJzb3VyY2UtbWFwXCI7XG5pbXBvcnQgeyBDb21waWxlciBhcyBXZWJwYWNrQ29tcGlsZXIgfSBmcm9tIFwid2VicGFja1wiO1xuaW1wb3J0IHsgQ29uY2F0U291cmNlLCBSYXdTb3VyY2UsIFNvdXJjZSwgU291cmNlTWFwU291cmNlIH0gZnJvbSBcIndlYnBhY2stc291cmNlc1wiO1xuXG5pbXBvcnQgeyBXZWJwYWNrQW55IH0gZnJvbSBcIi4vUGx1Z2luXCI7XG5cbi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpwcmVmZXItd2hhdGV2ZXItdG8tYW55XG5leHBvcnQgdHlwZSBQb3N0Y3NzQW55ID0gYW55O1xuXG5jb25zdCBkZWJ1ZyA9IGRlYnVnR2VuZXJhdG9yKFwiY3NzLWJsb2Nrczp3ZWJwYWNrOmFzc2V0c1wiKTtcblxuZXhwb3J0IHR5cGUgUG9zdGNzc1Byb2Nlc3NvciA9XG4gICAgQXJyYXk8cG9zdGNzcy5QbHVnaW48UG9zdGNzc0FueT4+XG4gICAgICAgIHwgKChhc3NldFBhdGg6IHN0cmluZykgPT4gQXJyYXk8cG9zdGNzcy5QbHVnaW48UG9zdGNzc0FueT4+XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgUHJvbWlzZTxBcnJheTxwb3N0Y3NzLlBsdWdpbjxQb3N0Y3NzQW55Pj4+KTtcblxuZXhwb3J0IHR5cGUgR2VuZXJpY1Byb2Nlc3NvciA9XG4gICAgKHNvdXJjZTogU291cmNlLCBhc3NldFBhdGg6IHN0cmluZykgPT4gU291cmNlIHwgUHJvbWlzZTxTb3VyY2U+O1xuXG5leHBvcnQgaW50ZXJmYWNlIFBvc3Rjc3NQcm9jZXNzb3JPcHRpb24ge1xuICAgIHBvc3Rjc3M6IFBvc3Rjc3NQcm9jZXNzb3I7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgR2VuZXJpY1Byb2Nlc3Nvck9wdGlvbiB7XG4gICAgcHJvY2Vzc29yOiBHZW5lcmljUHJvY2Vzc29yO1xufVxuXG5leHBvcnQgdHlwZSBQb3N0UHJvY2Vzc29yT3B0aW9uID0gUG9zdGNzc1Byb2Nlc3Nvck9wdGlvbiB8IEdlbmVyaWNQcm9jZXNzb3JPcHRpb24gfCAoUG9zdGNzc1Byb2Nlc3Nvck9wdGlvbiAmIEdlbmVyaWNQcm9jZXNzb3JPcHRpb24pO1xuXG5mdW5jdGlvbiBpc1Bvc3Rjc3NQcm9jZXNzb3IocHJvY2Vzc29yOiBQb3N0UHJvY2Vzc29yT3B0aW9uKTogcHJvY2Vzc29yIGlzIFBvc3Rjc3NQcm9jZXNzb3JPcHRpb24ge1xuICAgIHJldHVybiAhISg8UG9zdGNzc1Byb2Nlc3Nvck9wdGlvbj5wcm9jZXNzb3IpLnBvc3Rjc3M7XG59XG5cbmZ1bmN0aW9uIGlzR2VuZXJpY1Byb2Nlc3Nvcihwcm9jZXNzb3I6IFBvc3RQcm9jZXNzb3JPcHRpb24pOiBwcm9jZXNzb3IgaXMgR2VuZXJpY1Byb2Nlc3Nvck9wdGlvbiB7XG4gICAgcmV0dXJuICEhKDxHZW5lcmljUHJvY2Vzc29yT3B0aW9uPnByb2Nlc3NvcikucHJvY2Vzc29yO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENzc1NvdXJjZU9wdGlvbnMge1xuICAgIC8qKlxuICAgICAqIFRoZSBuYW1lIG9mIHRoZSBjaHVuayB0byB3aGljaCB0aGUgYXNzZXQgc2hvdWxkIGJlbG9uZy5cbiAgICAgKiBJZiBvbWl0dGVkLCB0aGUgYXNzZXQgd29uJ3QgYmVsb25nIHRvIGEgYW55IGNodW5rLiAqL1xuICAgIGNodW5rOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgICAvKiogdGhlIHNvdXJjZSBwYXRoIHRvIHRoZSBjc3MgYXNzZXQuICovXG4gICAgc291cmNlOiBzdHJpbmcgfCBzdHJpbmdbXTtcblxuICAgIC8qKlxuICAgICAqIFBvc3QtcHJvY2VzcyB0aGUgY29uY2F0ZW5hdGVkIGZpbGUgd2l0aCB0aGUgc3BlY2lmaWVkIHBvc3Rjc3MgcGx1Z2lucy5cbiAgICAgKi9cbiAgICAvLyBUT0RPOiBlbmFibGVcbiAgICAvLyBwb3N0UHJvY2Vzcz86IFBvc3RQcm9jZXNzb3JPcHRpb247XG59XG5leHBvcnQgaW50ZXJmYWNlIENvbmNhdGVuYXRpb25PcHRpb25zIHtcbiAgICAvKipcbiAgICAgKiBBIGxpc3Qgb2YgYXNzZXRzIHRvIGJlIGNvbmNhdGVuYXRlZC5cbiAgICAgKi9cbiAgICBzb3VyY2VzOiBBcnJheTxzdHJpbmc+O1xuXG4gICAgLyoqXG4gICAgICogV2hlbiB0cnVlLCB0aGUgZmlsZXMgdGhhdCBhcmUgY29uY2F0ZW5hdGVkIGFyZSBsZWZ0IGluIHRoZSBidWlsZC5cbiAgICAgKiBEZWZhdWx0cyB0byBmYWxzZS5cbiAgICAgKi9cbiAgICBwcmVzZXJ2ZVNvdXJjZUZpbGVzPzogYm9vbGVhbjtcblxuICAgIC8qKlxuICAgICAqIFBvc3QtcHJvY2VzcyB0aGUgY29uY2F0ZW5hdGVkIGZpbGUgd2l0aCB0aGUgc3BlY2lmaWVkIHBvc3Rjc3MgcGx1Z2lucy5cbiAgICAgKlxuICAgICAqIElmIHBvc3Rjc3MgcGx1Z2lucyBhcmUgcHJvdmlkZWQgaW4gY29uanVuY3Rpb24gd2l0aCBhIGdlbmVyaWMgcHJvY2Vzc29yXG4gICAgICogdGhlIHBvc3Rjc3MgcGx1Z2lucyB3aWxsIGJlIHJhbiBmaXJzdC5cbiAgICAgKi9cbiAgICBwb3N0UHJvY2Vzcz86IFBvc3RQcm9jZXNzb3JPcHRpb247XG59XG5cbi8qKlxuICogT3B0aW9ucyBmb3IgbWFuYWdpbmcgQ1NTIGFzc2V0cyB3aXRob3V0IGphdmFzY3JpcHQgaW1wb3J0cy5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDc3NBc3NldHNPcHRpb25zIHtcbiAgICAvKiogTWFwcyBjc3MgZmlsZXMgZnJvbSBhIHNvdXJjZSBsb2NhdGlvbiB0byBhIHdlYnBhY2sgYXNzZXQgbG9jYXRpb24uICovXG4gICAgY3NzRmlsZXM6IE9iamVjdERpY3Rpb25hcnk8c3RyaW5nIHwgQ3NzU291cmNlT3B0aW9ucz47XG4gICAgLyoqXG4gICAgICogTWFwcyBzZXZlcmFsIHdlYnBhY2sgYXNzZXRzIHRvIGEgbmV3IGNvbmNhdGVuYXRlZCBhc3NldCBhbmQgbWFuYWdlcyB0aGVpclxuICAgICAqIHNvdXJjZW1hcHMuIFRoZSBjb25jYXRlbmF0ZWQgYXNzZXQgd2lsbCBiZWxvbmcgdG8gYWxsIHRoZSBjaHVua3MgdG8gd2hpY2hcbiAgICAgKiB0aGUgYXNzZXRzIGJlbG9uZ2VkLlxuICAgICAqL1xuICAgIGNvbmNhdDogT2JqZWN0RGljdGlvbmFyeTxzdHJpbmdbXSB8IENvbmNhdGVuYXRpb25PcHRpb25zPjtcblxuICAgIC8qKlxuICAgICAqIFdoZW4gdHJ1ZSwgYW55IHNvdXJjZSBtYXBzIHJlbGF0ZWQgdG8gdGhlIGFzc2V0cyBhcmUgd3JpdHRlbiBvdXQgYXNcbiAgICAgKiBhZGRpdGlvbmFsIGZpbGVzIG9yIGlubGluZSBkZXBlbmRpbmcgb24gdGhlIHZhbHVlIG9mIGBpbmxpbmVTb3VyY2VNYXBzYC5cbiAgICAgKi9cbiAgICBlbWl0U291cmNlTWFwczogYm9vbGVhbjsgLy8gZGVmYXVsdHMgdG8gdHJ1ZVxuICAgIC8qKlxuICAgICAqIFdoZXRoZXIgc291cmNlIG1hcHMgc2hvdWxkIGJlIGluY2x1ZGVkIGluIHRoZSBjc3MgZmlsZSBpdHNlbGYuIFRoaXNcbiAgICAgKiBzaG91bGQgb25seSBiZSB1c2VkIGluIGRldmVsb3BtZW50LlxuICAgICAqL1xuICAgIGlubGluZVNvdXJjZU1hcHM6IGJvb2xlYW47IC8vIGRlZmF1bHRzIHRvIGZhbHNlXG59XG5cbmludGVyZmFjZSBTb3VyY2VBbmRNYXAge1xuICAgIHNvdXJjZTogc3RyaW5nO1xuICAgIG1hcD86IFJhd1NvdXJjZU1hcDtcbn1cblxuZXhwb3J0IGNsYXNzIENzc0Fzc2V0cyB7XG4gIG9wdGlvbnM6IENzc0Fzc2V0c09wdGlvbnM7XG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IFBhcnRpYWw8Q3NzQXNzZXRzT3B0aW9ucz4pIHtcbiAgICAgICAgbGV0IGRlZmF1bHRPcHRzOiBDc3NBc3NldHNPcHRpb25zID0geyBjc3NGaWxlczoge30sIGNvbmNhdDoge30sIGVtaXRTb3VyY2VNYXBzOiB0cnVlLCBpbmxpbmVTb3VyY2VNYXBzOiBmYWxzZSB9O1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSBPYmplY3QuYXNzaWduKGRlZmF1bHRPcHRzLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgYXBwbHkoY29tcGlsZXI6IFdlYnBhY2tDb21waWxlcikge1xuICAgICAgICAvLyBpbnN0YWxsIGFzc2V0c1xuICAgICAgICAvLyBUaGlzIHB1dHMgYXNzZXRzIGludG8gdGhlIGNvbXBpbGF0aW9uIHJlc3VsdHMgYnV0IHRoZXkgd29uJ3QgYmUgcGFydCBvZlxuICAgICAgICAvLyBhbnkgY2h1bmsuIHRoZSBjc3NGaWxlcyBvcHRpb24gaXMgYW4gb2JqZWN0IHdoZXJlIHRoZSBrZXlzIGFyZVxuICAgICAgICAvLyB0aGUgYXNzZXQgdG8gYmUgYWRkZWQgaW50byB0aGUgY29tcGlsYXRpb24gcmVzdWx0cy4gVGhlIHZhbHVlXG4gICAgICAgIC8vIGNhbiBiZSBhIHBhdGggcmVsYXRpdmUgdG8gdGhlIHdlYnBhY2sgcHJvamVjdCByb290IG9yIGFuIGFic29sdXRlIHBhdGguXG4gICAgICAgIC8vIFRPRE86IGdldCB0aGUgd2F0Y2hlciB0byB3YXRjaCB0aGVzZSBmaWxlcyBvbiBkaXNrXG4gICAgICAgIC8vIFRPRE86IFVzZSBsb2FkZXJzIHRvIGdldCB0aGVzZSBmaWxlcyBpbnRvIHRoZSBhc3NldHMgLS0gd2hpY2ggbWF5IGhlbHAgd2l0aCB0aGUgd2F0Y2hpbmcuXG4gICAgICAgIGNvbXBpbGVyLnBsdWdpbihcImVtaXRcIiwgKGNvbXBpbGF0aW9uLCBjYikgPT4ge1xuICAgICAgICAgICAgZGVidWcoXCJlbWl0dGluZyBhc3NldHNcIik7XG4gICAgICAgICAgICBsZXQgYXNzZXRQYXRocyA9IE9iamVjdC5rZXlzKHRoaXMub3B0aW9ucy5jc3NGaWxlcyk7XG4gICAgICAgICAgICBhc3luYy5mb3JFYWNoKGFzc2V0UGF0aHMsIChhc3NldFBhdGgsIG91dHB1dENhbGxiYWNrKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGFzc2V0ID0gdGhpcy5vcHRpb25zLmNzc0ZpbGVzW2Fzc2V0UGF0aF07XG4gICAgICAgICAgICAgICAgbGV0IHNvdXJjZVBhdGg6IHN0cmluZyB8IHN0cmluZ1tdLCBjaHVua05hbWU6IHN0cmluZyB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGFzc2V0ID09PSBcInN0cmluZ1wiIHx8IEFycmF5LmlzQXJyYXkoYXNzZXQpKSB7XG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZVBhdGggPSBhc3NldDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzb3VyY2VQYXRoID0gYXNzZXQuc291cmNlO1xuICAgICAgICAgICAgICAgICAgICBjaHVua05hbWUgPSBhc3NldC5jaHVuaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGV0IGNodW5rczogV2VicGFja0FueVtdID0gY29tcGlsYXRpb24uY2h1bmtzO1xuICAgICAgICAgICAgICAgIGxldCBjaHVuazogV2VicGFja0FueSB8IHVuZGVmaW5lZCA9IGNodW5rTmFtZSAmJiBjaHVua3MuZmluZChjID0+IGMubmFtZSA9PT0gY2h1bmtOYW1lKTtcbiAgICAgICAgICAgICAgICBpZiAoY2h1bmtOYW1lICYmICFjaHVuaykge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIGNodW5rIG5hbWVkICR7Y2h1bmtOYW1lfSBmb3VuZC5gKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCBoYW5kbGVTb3VyY2UgPSAoZXJyOiBFcnJvciB8IHVuZGVmaW5lZCwgc291cmNlPzogU291cmNlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dENhbGxiYWNrKGVycik7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb21waWxhdGlvbi5hc3NldHNbYXNzZXRQYXRoXSA9IHNvdXJjZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaHVuaykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNodW5rLmZpbGVzLnB1c2goYXNzZXRQYXRoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dENhbGxiYWNrKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHNvdXJjZVBhdGgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNvdXJjZVBhdGhzID0gc291cmNlUGF0aC5tYXAoc291cmNlUGF0aCA9PiBwYXRoLnJlc29sdmUoY29tcGlsZXIub3B0aW9ucy5jb250ZXh0ISwgc291cmNlUGF0aCkpO1xuICAgICAgICAgICAgICAgICAgICBhc3NldEZpbGVzQXNTb3VyY2Uoc291cmNlUGF0aHMsIGhhbmRsZVNvdXJjZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYXNzZXRGaWxlQXNTb3VyY2UocGF0aC5yZXNvbHZlKGNvbXBpbGVyLm9wdGlvbnMuY29udGV4dCEsIHNvdXJjZVBhdGgpLCBoYW5kbGVTb3VyY2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sICAgICAgICAgICAgY2IpO1xuICAgICAgICB9KTtcbiAgICAgICAgLy8gQ29uY2F0ZW5hdGlvblxuICAgICAgICAvLyBUaGUgY29uY2F0IG9wdGlvbiBpcyBhbiBvYmplY3Qgd2hlcmUgdGhlIGtleXMgYXJlIHRoZVxuICAgICAgICAvLyBjb25jYXRlbmF0ZWQgYXNzZXQgcGF0aCBhbmQgdGhlIHZhbHVlIGlzIGFuIGFycmF5IG9mXG4gICAgICAgIC8vIHN0cmluZ3Mgb2YgYXNzZXRzIHRoYXQgc2hvdWxkIGJlIGluIHRoZSBhc3NldC5cbiAgICAgICAgLy8gVE9ETzogbWF5YmUgc29tZSBnbG9iIG9yIHJlZ2V4IHN1cHBvcnRcbiAgICAgICAgY29tcGlsZXIucGx1Z2luKFwiZW1pdFwiLCAoY29tcGlsYXRpb24sIGNiKSA9PiB7XG4gICAgICAgICAgICBkZWJ1ZyhcImNvbmNhdGVuYXRpbmcgYXNzZXRzXCIpO1xuICAgICAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuY29uY2F0KSByZXR1cm47XG4gICAgICAgICAgICBsZXQgY29uY2F0RmlsZXMgPSBPYmplY3Qua2V5cyh0aGlzLm9wdGlvbnMuY29uY2F0KTtcbiAgICAgICAgICAgIGxldCBwb3N0UHJvY2Vzc1Jlc3VsdHMgPSBuZXcgQXJyYXk8UHJvbWlzZTx2b2lkPj4oKTtcbiAgICAgICAgICAgIGZvciAobGV0IGNvbmNhdEZpbGUgb2YgY29uY2F0RmlsZXMpIHtcbiAgICAgICAgICAgICAgICBsZXQgY29uY2F0U291cmNlID0gbmV3IENvbmNhdFNvdXJjZSgpO1xuICAgICAgICAgICAgICAgIGxldCBjb25jYXRlbmF0aW9uID0gdGhpcy5vcHRpb25zLmNvbmNhdFtjb25jYXRGaWxlXTtcbiAgICAgICAgICAgICAgICBsZXQgaW5wdXRGaWxlcyA9IEFycmF5LmlzQXJyYXkoY29uY2F0ZW5hdGlvbikgPyBjb25jYXRlbmF0aW9uIDogY29uY2F0ZW5hdGlvbi5zb3VyY2VzO1xuICAgICAgICAgICAgICAgIGxldCBjb25jYXRlbmF0aW9uT3B0aW9ucyA9IEFycmF5LmlzQXJyYXkoY29uY2F0ZW5hdGlvbikgPyB7c291cmNlczogY29uY2F0ZW5hdGlvbn0gOiBjb25jYXRlbmF0aW9uO1xuICAgICAgICAgICAgICAgIGxldCBtaXNzaW5nRmlsZXMgPSBpbnB1dEZpbGVzLmZpbHRlcihmID0+ICghY29tcGlsYXRpb24uYXNzZXRzW2ZdKSk7XG4gICAgICAgICAgICAgICAgbGV0IGNodW5rcyA9IG5ldyBTZXQ8V2VicGFja0FueT4oKTtcbiAgICAgICAgICAgICAgICBpZiAobWlzc2luZ0ZpbGVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpbnB1dEZpbGUgb2YgaW5wdXRGaWxlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGFzc2V0ID0gY29tcGlsYXRpb24uYXNzZXRzW2lucHV0RmlsZV07XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25jYXRTb3VyY2UuYWRkKGFzc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBjaHVua3NXaXRoSW5wdXRBc3NldCA9IGNvbXBpbGF0aW9uLmNodW5rcy5maWx0ZXIoKGNodW5rOiBXZWJwYWNrQW55KSA9PiAoPEFycmF5PHN0cmluZz4+Y2h1bmsuZmlsZXMpLmluZGV4T2YoaW5wdXRGaWxlKSA+PSAwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNodW5rc1dpdGhJbnB1dEFzc2V0LmZvckVhY2goKGNodW5rOiBXZWJwYWNrQW55KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2h1bmtzLmFkZChjaHVuayk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGZpbGVzOiBzdHJpbmdbXSA9IGNodW5rLmZpbGVzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNodW5rLmZpbGVzID0gZmlsZXMuZmlsdGVyKGZpbGUgPT4gZmlsZSAhPT0gaW5wdXRGaWxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjb25jYXRlbmF0aW9uT3B0aW9ucy5wcmVzZXJ2ZVNvdXJjZUZpbGVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGNvbXBpbGF0aW9uLmFzc2V0c1tpbnB1dEZpbGVdO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChjb25jYXRlbmF0aW9uT3B0aW9ucy5wb3N0UHJvY2Vzcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcG9zdFByb2Nlc3NSZXN1bHRzLnB1c2gocG9zdFByb2Nlc3MoY29uY2F0ZW5hdGlvbk9wdGlvbnMucG9zdFByb2Nlc3MsIGNvbmNhdFNvdXJjZSwgY29uY2F0RmlsZSkudGhlbihzb3VyY2UgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGF0aW9uLmFzc2V0c1tjb25jYXRGaWxlXSA9IHNvdXJjZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGF0aW9uLmFzc2V0c1tjb25jYXRGaWxlXSA9IGNvbmNhdFNvdXJjZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmb3IgKGxldCBjaHVuayBvZiBjaHVua3MpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZpbGVzOiBBcnJheTxzdHJpbmc+ID0gY2h1bmsuZmlsZXM7XG4gICAgICAgICAgICAgICAgICAgIGlmIChmaWxlcy5pbmRleE9mKGNvbmNhdEZpbGUpID49IDApIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICBmaWxlcy5wdXNoKGNvbmNhdEZpbGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwb3N0UHJvY2Vzc1Jlc3VsdHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIFByb21pc2UuYWxsKHBvc3RQcm9jZXNzUmVzdWx0cykudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNiKCk7XG4gICAgICAgICAgICAgICAgfSwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY2IoZXJyb3IpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjYigpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBzb3VyY2VtYXAgb3V0cHV0IGZvciBjc3MgZmlsZXNcbiAgICAgICAgLy8gRW1pdCBhbGwgY3NzIGZpbGVzIHdpdGggc291cmNlbWFwcyB3aGVuIHRoZSBgZW1pdFNvdXJjZU1hcHNgIG9wdGlvblxuICAgICAgICAvLyBpcyBzZXQgdG8gdHJ1ZSAoZGVmYXVsdCkuIEJ5IGRlZmF1bHQgc291cmNlIG1hcHMgYXJlIGdlbmVyYXRlZCBhcyBhXG4gICAgICAgIC8vIHNlcGFyYXRlIGZpbGUgYnV0IHRoZXkgY2FuIGJlIGlubGluZSBieSBzZXR0aW5nIGBpbmxpbmVTb3VyY2VNYXBzYCB0b1xuICAgICAgICAvLyB0cnVlIChmYWxzZSBieSBkZWZhdWx0KVxuICAgICAgICBjb21waWxlci5wbHVnaW4oXCJlbWl0XCIsIChjb21waWxhdGlvbiwgY2IpID0+IHtcbiAgICAgICAgICAgIGlmICghdGhpcy5vcHRpb25zLmVtaXRTb3VyY2VNYXBzKSB7XG4gICAgICAgICAgICAgICAgZGVidWcoXCJub3QgYWRkaW5nIHNvdXJjZW1hcHNcIik7XG4gICAgICAgICAgICAgICAgY2IoKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkZWJ1ZyhcImFkZGluZyBzb3VyY2VtYXBzXCIpO1xuICAgICAgICAgICAgbGV0IGFzc2V0UGF0aHMgPSBPYmplY3Qua2V5cyhjb21waWxhdGlvbi5hc3NldHMpLmZpbHRlcihwID0+IC9cXC5jc3MkLy50ZXN0KHApKTtcbiAgICAgICAgICAgIGFzc2V0UGF0aHMuZm9yRWFjaChhc3NldFBhdGggPT4ge1xuICAgICAgICAgICAgICAgIGxldCBhc3NldCA9IGNvbXBpbGF0aW9uLmFzc2V0c1thc3NldFBhdGhdO1xuICAgICAgICAgICAgICAgIGxldCB7c291cmNlLCBtYXB9ID0gc291cmNlQW5kTWFwKGFzc2V0KTtcbiAgICAgICAgICAgICAgICBpZiAobWFwKSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBjb21tZW50O1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmlubGluZVNvdXJjZU1hcHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1lbnQgPSBjb252ZXJ0U291cmNlTWFwLmZyb21PYmplY3QobWFwKS50b0NvbW1lbnQoeyBtdWx0aWxpbmU6IHRydWUgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgbWFwUGF0aCA9IGFzc2V0UGF0aCArIFwiLm1hcFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29tbWVudCA9IGAvKiMgc291cmNlTWFwcGluZ1VSTD0ke3BhdGguYmFzZW5hbWUobWFwUGF0aCl9ICovYDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGF0aW9uLmFzc2V0c1ttYXBQYXRoXSA9IG5ldyBSYXdTb3VyY2UoSlNPTi5zdHJpbmdpZnkobWFwKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY29tcGlsYXRpb24uYXNzZXRzW2Fzc2V0UGF0aF0gPSBuZXcgUmF3U291cmNlKHNvdXJjZSArIFwiXFxuXCIgKyBjb21tZW50KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNiKCk7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gYXNzZXRBc1NvdXJjZShjb250ZW50czogc3RyaW5nLCBmaWxlbmFtZTogc3RyaW5nKTogU291cmNlIHtcbiAgICBsZXQgc291cmNlbWFwOiBjb252ZXJ0U291cmNlTWFwLlNvdXJjZU1hcENvbnZlcnRlciB8IHVuZGVmaW5lZDtcbiAgICBpZiAoL3NvdXJjZU1hcHBpbmdVUkwvLnRlc3QoY29udGVudHMpKSB7XG4gICAgICAgIHNvdXJjZW1hcCA9IGNvbnZlcnRTb3VyY2VNYXAuZnJvbVNvdXJjZShjb250ZW50cykgfHxcbiAgICAgICAgICAgIGNvbnZlcnRTb3VyY2VNYXAuZnJvbU1hcEZpbGVDb21tZW50KGNvbnRlbnRzLCBwYXRoLmRpcm5hbWUoZmlsZW5hbWUpKTtcbiAgICB9XG4gICAgaWYgKHNvdXJjZW1hcCkge1xuICAgICAgICBsZXQgc206IFJhd1NvdXJjZU1hcCA9IHNvdXJjZW1hcC50b09iamVjdCgpO1xuICAgICAgICBjb250ZW50cyA9IGNvbnZlcnRTb3VyY2VNYXAucmVtb3ZlQ29tbWVudHMoY29udGVudHMpO1xuICAgICAgICBjb250ZW50cyA9IGNvbnZlcnRTb3VyY2VNYXAucmVtb3ZlTWFwRmlsZUNvbW1lbnRzKGNvbnRlbnRzKTtcbiAgICAgICAgcmV0dXJuIG5ldyBTb3VyY2VNYXBTb3VyY2UoY29udGVudHMsIGZpbGVuYW1lLCBzbSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG5ldyBSYXdTb3VyY2UoY29udGVudHMpO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gYXNzZXRGaWxlc0FzU291cmNlKGZpbGVuYW1lczogc3RyaW5nW10sIGNhbGxiYWNrOiAoZXJyOiBFcnJvciB8IHVuZGVmaW5lZCwgc291cmNlPzogQ29uY2F0U291cmNlKSA9PiB2b2lkKSB7XG4gICAgbGV0IGFzc2V0U291cmNlID0gbmV3IENvbmNhdFNvdXJjZSgpO1xuICAgIGxldCBhc3NldEZpbGVzID0gZmlsZW5hbWVzLnNsaWNlKCk7XG4gICAgbGV0IGVhY2hBc3NldEZpbGUgPSAoZXJyPzogRXJyb3IpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgY2FsbGJhY2soZXJyKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IG5leHRBc3NldEZpbGUgPSBhc3NldEZpbGVzLnNoaWZ0KCk7XG4gICAgICAgICAgICBpZiAobmV4dEFzc2V0RmlsZSkge1xuICAgICAgICAgICAgICAgIHByb2Nlc3NBc3NldChuZXh0QXNzZXRGaWxlLCBlYWNoQXNzZXRGaWxlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2sodW5kZWZpbmVkLCBhc3NldFNvdXJjZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9O1xuICAgIGNvbnN0IGZpcnN0QXNzZXRGaWxlID0gYXNzZXRGaWxlcy5zaGlmdCgpO1xuICAgIGlmIChmaXJzdEFzc2V0RmlsZSkge1xuICAgICAgICBwcm9jZXNzQXNzZXQoZmlyc3RBc3NldEZpbGUsIGVhY2hBc3NldEZpbGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcihcIk5vIGFzc2V0IGZpbGVzIHByb3ZpZGVkLlwiKSk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIHByb2Nlc3NBc3NldChhc3NldFBhdGg6IHN0cmluZywgYXNzZXRDYWxsYmFjazogKGVycj86IEVycm9yKSA9PiB2b2lkKSB7XG4gICAgICAgIGZzLnJlYWRGaWxlKGFzc2V0UGF0aCwgXCJ1dGYtOFwiLCAoZXJyLCBkYXRhKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgYXNzZXRDYWxsYmFjayhlcnIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgYXNzZXRTb3VyY2UuYWRkKGFzc2V0QXNTb3VyY2UoZGF0YSwgYXNzZXRQYXRoKSk7XG4gICAgICAgICAgICAgIGFzc2V0Q2FsbGJhY2soKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBhc3NldEZpbGVBc1NvdXJjZShzb3VyY2VQYXRoOiBzdHJpbmcsIGNhbGxiYWNrOiAoZXJyOiBFcnJvciB8IHVuZGVmaW5lZCwgc291cmNlPzogU291cmNlKSA9PiB2b2lkKSB7XG4gICAgZnMucmVhZEZpbGUoc291cmNlUGF0aCwgXCJ1dGYtOFwiLCAoZXJyLCBjb250ZW50cykgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICBjYWxsYmFjayhlcnIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayh1bmRlZmluZWQsIGFzc2V0QXNTb3VyY2UoY29udGVudHMsIHNvdXJjZVBhdGgpKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBzb3VyY2VBbmRNYXAoYXNzZXQ6IFNvdXJjZSk6IFNvdXJjZUFuZE1hcCB7XG4gICAgLy8gc291cmNlQW5kTWFwIGlzIHN1cHBvc2VkbHkgbW9yZSBlZmZpY2llbnQgd2hlbiBpbXBsZW1lbnRlZC5cbiAgICBpZiAoYXNzZXQuc291cmNlQW5kTWFwKSB7XG4gICAgICAgIHJldHVybiBhc3NldC5zb3VyY2VBbmRNYXAoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBsZXQgc291cmNlID0gYXNzZXQuc291cmNlKCk7XG4gICAgICAgIGxldCBtYXA6IFJhd1NvdXJjZU1hcCB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgaWYgKGFzc2V0Lm1hcCkge1xuICAgICAgICAgICAgbWFwID0gYXNzZXQubWFwKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHsgc291cmNlLCBtYXAgfTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIG1ha2VQb3N0Y3NzUHJvY2Vzc29yIChcbiAgICBwbHVnaW5zOiBQb3N0Y3NzUHJvY2Vzc29yLFxuKTogR2VuZXJpY1Byb2Nlc3NvciB7XG4gICAgcmV0dXJuIChhc3NldDogU291cmNlLCBhc3NldFBhdGg6IHN0cmluZykgPT4ge1xuICAgICAgICBsZXQgeyBzb3VyY2UsIG1hcCB9ID0gc291cmNlQW5kTWFwKGFzc2V0KTtcbiAgICAgICAgbGV0IHBsdWdpbnNQcm9taXNlOiBQcm9taXNlPEFycmF5PHBvc3Rjc3MuUGx1Z2luPFBvc3Rjc3NBbnk+Pj47XG4gICAgICAgIGlmICh0eXBlb2YgcGx1Z2lucyA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICBwbHVnaW5zUHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZShwbHVnaW5zKGFzc2V0UGF0aCkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHBsdWdpbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHBsdWdpbnNQcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKHBsdWdpbnMpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGFzc2V0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcGx1Z2luc1Byb21pc2UudGhlbihwbHVnaW5zID0+IHtcbiAgICAgICAgICAgIGxldCBwcm9jZXNzb3IgPSBwb3N0Y3NzKHBsdWdpbnMpO1xuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IHByb2Nlc3Nvci5wcm9jZXNzKHNvdXJjZSwge1xuICAgICAgICAgICAgICAgIHRvOiBhc3NldFBhdGgsXG4gICAgICAgICAgICAgICAgbWFwOiB7IHByZXY6IG1hcCwgaW5saW5lOiBmYWxzZSwgYW5ub3RhdGlvbjogZmFsc2UgfSxcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0LnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgU291cmNlTWFwU291cmNlKHJlc3VsdC5jc3MsIGFzc2V0UGF0aCwgcmVzdWx0Lm1hcC50b0pTT04oKSwgc291cmNlLCBtYXApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH07XG59XG5cbmZ1bmN0aW9uIHByb2Nlc3MocHJvY2Vzc29yOiBHZW5lcmljUHJvY2Vzc29yLCBhc3NldDogU291cmNlLCBhc3NldFBhdGg6IHN0cmluZykge1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUocHJvY2Vzc29yKGFzc2V0LCBhc3NldFBhdGgpKTtcbn1cblxuZnVuY3Rpb24gcG9zdFByb2Nlc3Mob3B0aW9uOiBQb3N0UHJvY2Vzc29yT3B0aW9uLCBhc3NldDogU291cmNlLCBhc3NldFBhdGg6IHN0cmluZyk6IFByb21pc2U8U291cmNlPiB7XG4gICAgbGV0IHByb21pc2U6IFByb21pc2U8U291cmNlPjtcbiAgICBpZiAoaXNQb3N0Y3NzUHJvY2Vzc29yKG9wdGlvbikpIHtcbiAgICAgICAgcHJvbWlzZSA9IHByb2Nlc3MobWFrZVBvc3Rjc3NQcm9jZXNzb3Iob3B0aW9uLnBvc3Rjc3MpLCBhc3NldCwgYXNzZXRQYXRoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBwcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKGFzc2V0KTtcbiAgICB9XG4gICAgaWYgKGlzR2VuZXJpY1Byb2Nlc3NvcihvcHRpb24pKSB7XG4gICAgICAgIHByb21pc2UgPSBwcm9taXNlLnRoZW4oYXNzZXQgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3Mob3B0aW9uLnByb2Nlc3NvciwgYXNzZXQsIGFzc2V0UGF0aCk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gcHJvbWlzZTtcbn1cbiJdfQ==